<html>

    <head>
        <title>ninja-cat famicom cartridges</title>
    </head>

    <body>
        <script src="http://code.jquery.com/jquery.min.js" type="text/javascript"></script>
        <script type="text/javascript">
           
            var groups = {};
            var carts = {}; 

            function create_groups(data){
                var groups = {};
                var all_carts = 0;
                $.each(data, function(cart_id, value){
                    var group = value['group'];
                    if (!(group in groups)){
                        groups[group] = [];
                    }; 
                    groups[group].push(cart_id);
                    all_carts ++;
                });
                groups['all'] = all_carts;
                return groups;
             }

            function clean_cart_list(){
                $("#cart_selector").empty();
            }
            
            function show_selected(){
                var selected_options = $("#cart_selector option:selected");
                $.each(selected_options, function(idx, cart_id){
                    info_list = $("ul#shock_content").empty();
                    $.each(carts[cart_id.value], function(key, value){
                        listItem = document.createElement("li");
                        text = document.createTextNode(key + ": " + value);
                        listItem.appendChild(text);
                        info_list.append(listItem);
                    });
                });
            }            

            function add_group_to_list(group){
                $.each(groups[group], function(idx, cart_id){
                    $('#cart_selector').append($("<option/>", {
                        value: cart_id,
                        text: carts[cart_id]["short_title"]
                    }));
                });
            }

            function create_list_from_checked_groups(){
                clean_cart_list();
                items = $("input","ul#fami_tags li");
                $.each(items, function(idx, val){
                    if (idx > 0 && val.checked){
                            add_group_to_list(val.name);
                    }
                });
                $("#cart_selector").change(show_selected);
            }

            function check_all_groups(){
                clean_cart_list();
                items = $("input","ul#fami_tags li");
                checked = items[0].checked;
                $.each(items, function(idx, val){
                        val.checked = checked;
                });
                create_list_from_checked_groups();
            }

            function create_group_checkboxes(groups){
                inputs = $("ul#fami_tags");
                inputs.empty();
                $.each(groups, function(group, value){
                    listItem = document.createElement("li");
                    inputItem = document.createElement("input");
                    inputItem.type = "checkbox";
                    inputItem.name = group;
                    inputItem.value = group;
                    listItem.appendChild(inputItem);
                    if (group == 'all'){
                        labeltext = document.createTextNode(group + ' ('+ value + '):');
                        inputItem.onchange = check_all_groups;
                        inputs.prepend(listItem);
                    } else {
                        labeltext = document.createTextNode(group + ' ('+ value.length + ');');
                        inputItem.onchange = create_list_from_checked_groups; 
                        inputs.append(listItem);
                    }
                    listItem.appendChild(labeltext);
                });
                delete groups.all;
            }

            function load_cart_db(){
                $.getJSON('cart.js', function(data){
                    carts = data;
                    groups = create_groups(data);
                    create_group_checkboxes(groups);  
                    clean_cart_list(); 
                });
            }

            load_cart_db();
        </script>

        <div>
            <ul id="fami_tags">
            </ul>
        </div>

        <hr>

        <table border="0">
            <tr>
                <td style="vertical-align: top;">
                    <div id="cart_list" >
                        <select id="cart_selector" name="carts" size="25">
                        </select>
                    </div>
                </td>
                <td style="vertical-align: top;">
                    <div style="overflow:auto;">
                        <ul id="shock_content">
                            <li>enable shitty javascript on this page</li>
                            <li>check one or more publisher group</li>
                            <li>then select title from the list</li>
                            <li>enjoy!</li>
                        </ul>
                    </div>
                </td>
          </tr>
        </table>

    </body>
</html>
